#!/usr/bin/env zsh

# Configuration
CONFIG_FILE="$HOME/.config/opencode/opencode.json"

# Define MCP presets
declare -A presets
presets=(
  [ios-dev]="mobile-mcp simctl-mcp xcodebuild-mcp peekaboo"
  [web-dev]="vibium"
  [cli-dev]="shellwright"
  [research]="exa deepwiki firecrawl"
)

usage() {
  echo "Usage:"
  echo "  oc-mcp <preset> <enable|disable>"
  echo "  oc-mcp list"
  exit 1
}

list_mcps() {
  echo "Presets:"
  for k in ${(k)presets}; do
    echo "  - $k: ${presets[$k]}"
  done
  echo "\nDefined MCPs (from config):"
  if [[ -f "$CONFIG_FILE" ]]; then
    jq -r '.mcp | to_entries[] | "  - \(.key) (enabled: \(.value.enabled))"' "$CONFIG_FILE"
  else
    echo "  Config file not found."
  fi
  exit 0
}

if [[ "$1" == "list" ]]; then
  list_mcps
fi

if [[ $# -ne 2 ]]; then
  usage
fi

PRESET=$1
ACTION=$2
MCP_LIST=(${(s: :)presets[$PRESET]})

if [[ -z "$MCP_LIST" ]]; then
  echo "Error: Preset '$PRESET' not found."
  usage
fi

case $ACTION in
  enable)  ENABLED_VAL="true" ;;
  disable) ENABLED_VAL="false" ;;
  *) usage ;;
esac

# Build jq command to update each MCP in the preset
JQ_CMD="."
for mcp in $MCP_LIST; do
  # We use select(.mcp["$mcp"]) to check if the key exists before attempting update
  JQ_CMD="$JQ_CMD | if .mcp[\"$mcp\"] then .mcp[\"$mcp\"].enabled = $ENABLED_VAL else . end"
done

# Perform the update
if jq "$JQ_CMD" "$CONFIG_FILE" > "$CONFIG_FILE.tmp"; then
  mv "$CONFIG_FILE.tmp" "$CONFIG_FILE"
  echo "Successfully ${ACTION}d preset '$PRESET': $MCP_LIST"
else
  echo "Error updating config file."
  rm -f "$CONFIG_FILE.tmp"
  exit 1
fi
