#!/usr/bin/env zsh

source "${0:A:h}/_common.zsh"

CONFIG_FILE="$HOME/.config/opencode/opencode.json"

# Define MCP presets
typeset -A presets
presets=(
    "ios-dev" "mobile-mcp simctl-mcp xcodebuild-mcp sosumi"
    "web-dev" "vibium firecrawl exa"
    "research" "tavily exa ref"
    "automation" "peekaboo shellwright"
)

usage() {
    echo "Usage: $script_name <preset> <enable|disable>"
    echo "Presets:"
    for key in ${(k)presets}; do
        echo "  - $key: ${presets[$key]}"
    done
    exit 1
}

if [[ $# -lt 2 ]]; then
    usage
fi

PRESET=$1
ACTION=$2
export TARGET_VAL=""

if [[ "$ACTION" == "enable" ]]; then
    TARGET_VAL="true"
elif [[ "$ACTION" == "disable" ]]; then
    TARGET_VAL="false"
else
    usage
fi

MCP_LIST=${presets[$PRESET]}

if [[ -z "$MCP_LIST" ]]; then
    log_error "Unknown preset: $PRESET"
    usage
fi

if [[ ! -f "$CONFIG_FILE" ]]; then
    log_error "Config file not found: $CONFIG_FILE"
    exit 1
fi

log_message "Action: $(color %B%F{yellow} $ACTION) preset $(color %B%F{green} $PRESET)"

update_mcp_status() {
    local mcp_name=$1
    local tmp_file=$(mktemp)

    # Use environment variable to pass TARGET_VAL to Perl safely
    perl -0777 -pe "
        s/(\"$mcp_name\"\s*:\s*\{)(.*?)(\})/\$1 . update_enabled(\$2, \$ENV{TARGET_VAL}) . \$3/ges;
        sub update_enabled {
            my (\$c, \$v) = @_;
            if (\$c =~ /\"enabled\"\s*:/) {
                \$c =~ s/\"enabled\"\s*:\s*(?:true|false)/\"enabled\": \$v/g;
            } else {
                \$c = \"\n      \\\"enabled\\\": \$v,\" . \$c;
            }
            return \$c;
        }
    " "$CONFIG_FILE" > "$tmp_file"

    mv "$tmp_file" "$CONFIG_FILE"
}

for mcp in ${=MCP_LIST}; do
    log_message "Updating $(color %B%F{cyan} $mcp) to enabled: $TARGET_VAL"
    update_mcp_status "$mcp"
done

log_message "Done."
